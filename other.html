<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Milk Distributor - New Design</title>
  <!-- Google Font: Open Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link 
    href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" 
    rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
        integrity="sha512-pbF6xD30cxEwZIRckHEcaNV9ZdO+psC0vok+oR6R1yHc6/H7G6x3gB3RR/RSgV0P7/1G3v/xZ1B3F/7Nkf0Ctw==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --primary-color: #4caf50; /* A fresh green for “milk/farm” vibe */
      --secondary-color: #f6f6f6;
      --text-color: #333;
      --white: #ffffff;
      --card-bg: #fff;
      --border-color: #e0e0e0;
      --transition-speed: 0.3s;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Open Sans', sans-serif;
    }
    body {
      background-color: var(--secondary-color);
      color: var(--text-color);
    }
    /* Header */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--white);
      padding: 1rem 2rem;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .logo {
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--primary-color);
    }
    .search-bar {
      flex: 1;
      margin: 0 2rem;
      position: relative;
    }
    .search-bar input {
      width: 100%;
      padding: 0.5rem 2.5rem 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      outline: none;
    }
    .search-bar i {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #aaa;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .header-actions button,
    .header-actions .toggle-dark-mode {
      background: var(--primary-color);
      color: var(--white);
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background var(--transition-speed);
    }
    .header-actions button:hover,
    .header-actions .toggle-dark-mode:hover {
      background: #388e3c;
    }
    /* Sidebar */
    .sidebar {
      width: 220px;
      background-color: var(--white);
      height: calc(100vh - 70px);
      position: fixed;
      top: 70px;
      left: 0;
      padding: 1rem;
      box-shadow: 1px 0 4px rgba(0, 0, 0, 0.1);
    }
    .sidebar nav a {
      display: block;
      padding: 0.75rem 1rem;
      color: var(--text-color);
      text-decoration: none;
      border-radius: 4px;
      margin-bottom: 0.5rem;
      transition: background var(--transition-speed);
    }
    .sidebar nav a:hover {
      background-color: var(--secondary-color);
    }
    /* Main Content */
    .main-content {
      margin-left: 220px;
      padding: 2rem;
    }
    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    /* Summary Cards */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .card {
      background-color: var(--card-bg);
      border-radius: 6px;
      padding: 1rem;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }
    .card-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .card-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    .card select,
    .card input[type="month"] {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      width: 100%;
      outline: none;
    }
    /* Table */
    .table-container {
      background-color: var(--card-bg);
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    thead {
      background-color: var(--secondary-color);
    }
    th, td {
      text-align: left;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    tr:hover {
      background-color: #fafafa;
    }
    th {
      font-weight: 600;
    }
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      .main-content {
        margin-left: 0;
      }
      .search-bar {
        margin: 0 1rem;
      }
    }
    /* Dark Mode Styles */
    .dark-mode {
      background-color: #222;
      color: #fff;
    }
    .dark-mode header,
    .dark-mode .sidebar,
    .dark-mode .main-content,
    .dark-mode .card,
    .dark-mode .table-container,
    .dark-mode table {
      background-color: #333;
      color: #fff;
    }
    .dark-mode .search-bar input {
      background-color: #444;
      color: #fff;
      border-color: #555;
    }
    .dark-mode th, .dark-mode td {
      border-color: #555;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">Milk Distributor</div>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by Name, ID, or Phone..." onkeyup="searchCustomers()" />
      <i class="fa fa-search"></i>
    </div>
    <div class="header-actions">
      <button onclick="window.location.href='registration.html'">Register</button>
      <button id="darkModeBtn" class="toggle-dark-mode" onclick="toggleDarkMode()">Dark Mode</button>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar">
    <nav>
      <a href="#">Dashboard</a>
      <a href="#">Customers</a>
      <a href="#">Orders</a>
      <a href="#">Payments</a>
      <a href="#">Reports</a>
      <a href="#">Settings</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <div class="main-content">
    <h1 class="page-title">All Customers</h1>

    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="card">
        <div class="card-title">Total Customers</div>
        <div class="card-value" id="totalCustomersSummary">0</div>
      </div>
      <div class="card">
        <div class="card-title">Due Payments (This Month)</div>
        <div class="card-value" id="duePaymentsSummary">0</div>
      </div>
      <div class="card">
        <div class="card-title">Received Payments (This Month)</div>
        <div class="card-value" id="receivedPaymentsSummary">0</div>
      </div>
      <div class="card">
        <div class="card-title">Select Month</div>
        <input type="month" id="monthSelector" onchange="updateMonthlySummary()" />
      </div>
    </div>

    <!-- Customer Table -->
    <div class="table-container">
      <table id="customersTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Customer ID</th>
            <th>Customer Name</th>
            <th>Phone No</th>
            <th>Address</th>
            <th>Quantity (This Month)</th>
          </tr>
        </thead>
        <tbody id="customersTableBody">
          <!-- Dynamic rows will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Toast Notifications Container -->
  <div id="toastContainer" style="position: fixed; top: 1rem; right: 1rem; z-index: 1055;"></div>

  <!-- JavaScript -->
  <script>
    // ---------------------------
    // Data Initialization & Rendering
    // ---------------------------
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    let customers = {};
    if (localStorage.getItem("customers")) {
      customers = JSON.parse(localStorage.getItem("customers"));
    } else {
      customers = {
        1: { name: "John Doe", id: 1, phone: "1234567890", address: "123 Milk St", monthQuantity: 0, paymentStatus: "Pending" },
        2: { name: "Jane Smith", id: 2, phone: "0987654321", address: "456 Dairy Ave", monthQuantity: 0, paymentStatus: "Pending" },
        3: { name: "Bob Johnson", id: 3, phone: "5551234567", address: "789 Cream Rd", monthQuantity: 0, paymentStatus: "Pending" }
      };
      localStorage.setItem("customers", JSON.stringify(customers));
    }

    let dailyData = [];
    if (!localStorage.getItem("dailyData")) {
      dailyData = [
        { date: "2023-09-01", quantity: "10", price: "700", customerId: 1, milkType: "cow", paymentStatus: "Due" },
        { date: "2023-09-02", quantity: "5", price: "350", customerId: 2, milkType: "cow", paymentStatus: "Received" },
        { date: "2023-09-03", quantity: "8", price: "560", customerId: 3, milkType: "cow", paymentStatus: "Due" },
        { date: "2023-09-04", quantity: "12", price: "840", customerId: 1, milkType: "cow", paymentStatus: "Received" }
      ];
      localStorage.setItem("dailyData", JSON.stringify(dailyData));
    } else {
      dailyData = JSON.parse(localStorage.getItem("dailyData"));
    }

    // ---------------------------
    // Update Monthly Quantities
    // ---------------------------
    function updateMonthlyQuantities() {
      // Reset monthly quantity for each customer
      for (let id in customers) {
        customers[id].monthQuantity = 0;
      }
      
      // Get the current month in "YYYY-MM" format
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth() + 1;
      const formattedMonth = `${year}-${month < 10 ? '0' + month : month}`;
      
      // Sum up daily quantities for entries in the current month
      dailyData.forEach(entry => {
        if (entry.date.substring(0, 7) === formattedMonth) {
          const quantity = parseFloat(entry.quantity) || 0;
          if (customers[entry.customerId]) {
            customers[entry.customerId].monthQuantity += quantity;
          }
        }
      });
      
      // Update localStorage with the new customers data
      localStorage.setItem("customers", JSON.stringify(customers));
    }

    // ---------------------------
    // Render Customers Table
    // ---------------------------
    function renderCustomersTable() {
      const tbody = document.getElementById("customersTableBody");
      tbody.innerHTML = "";
      let index = 1;
      for (let id in customers) {
        const cust = customers[id];
        const row = document.createElement("tr");
        row.onclick = () => redirectToCustomerDetails(cust.id);
        row.style.cursor = "pointer";
        row.innerHTML = `
          <td>${index++}</td>
          <td>${cust.id}</td>
          <td>${cust.name}</td>
          <td>${cust.phone}</td>
          <td>${cust.address}</td>
          <td>${cust.monthQuantity} L</td>
        `;
        tbody.appendChild(row);
      }
    }

    function redirectToCustomerDetails(customerId) {
      window.location.href = "customerDetails.html?customerId=" + customerId;
    }

    // ---------------------------
    // Custom Search Function
    // ---------------------------
    function searchCustomers() {
      const searchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
      const rows = document.querySelectorAll("#customersTableBody tr");
      rows.forEach(row => {
        const cells = row.getElementsByTagName("td");
        let combinedText = "";
        if (cells.length >= 3) {
          combinedText = cells[1].textContent.toLowerCase() + " " +
                         cells[2].textContent.toLowerCase() + " " +
                         cells[3].textContent.toLowerCase();
        }
        row.style.display = combinedText.includes(searchTerm) ? "" : "none";
      });
    }

    // ---------------------------
    // Monthly Summary Section
    // ---------------------------
    function updateMonthlySummary() {
      let filteredEntries = [];
      let selectedMonth = document.getElementById("monthSelector").value;
      if (!selectedMonth) {
        // If no month selected, default to current month
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;
        selectedMonth = `${year}-${month < 10 ? '0' + month : month}`;
      }
      filteredEntries = dailyData.filter(entry => entry.date.substring(0,7) === selectedMonth);
      
      const uniqueCustomers = new Set(filteredEntries.map(entry => entry.customerId));
      const totalCustomers = uniqueCustomers.size;
      let duePayments = 0, receivedPayments = 0;
      filteredEntries.forEach(entry => {
        const amount = parseFloat(entry.price) || 0;
        if (entry.paymentStatus && entry.paymentStatus.toLowerCase() === "received") {
          receivedPayments += amount;
        } else {
          duePayments += amount;
        }
      });
      document.getElementById("totalCustomersSummary").innerText = totalCustomers;
      document.getElementById("duePaymentsSummary").innerText = "$" + duePayments;
      document.getElementById("receivedPaymentsSummary").innerText = "$" + receivedPayments;
    }

    // ---------------------------
    // Toast Notifications
    // ---------------------------
    function showToast(message, type) {
      const toastContainer = document.getElementById("toastContainer");
      const toastEl = document.createElement("div");
      toastEl.className = `toast align-items-center text-bg-${type} border-0`;
      toastEl.setAttribute("role", "alert");
      toastEl.setAttribute("aria-live", "assertive");
      toastEl.setAttribute("aria-atomic", "true");
      toastEl.style.marginBottom = "0.5rem";
      toastEl.innerHTML = `<div class="d-flex">
                              <div class="toast-body">${message}</div>
                              <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
                           </div>`;
      toastContainer.appendChild(toastEl);
      setTimeout(() => {
        toastEl.remove();
      }, 3000);
    }

    // ---------------------------
    // Dark Mode Toggle
    // ---------------------------
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDarkMode = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
      showToast(`${isDarkMode ? 'Dark' : 'Light'} mode enabled`, 'info');
    }

    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }

    // ---------------------------
    // Initialization & Keyboard Shortcuts
    // ---------------------------
    document.addEventListener("DOMContentLoaded", () => {
      // Set monthSelector to current month if not already set
      const monthInput = document.getElementById("monthSelector");
      const today = new Date();
      const month = today.getMonth() + 1;
      const year = today.getFullYear();
      const formattedMonth = (month < 10 ? "0" : "") + month;
      monthInput.value = `${year}-${formattedMonth}`;

      updateMonthlyQuantities();
      updateMonthlySummary();
      renderCustomersTable();
    });

    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + D toggles dark mode
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'd') {
        e.preventDefault();
        toggleDarkMode();
      }
      // Ctrl/Cmd + F focuses search input
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
      }
    });
  </script>
</body>
</html>
