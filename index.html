<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Milk Distributor - Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
        integrity="sha512-pbF6xD30cxEwZIRckHEcaNV9ZdO+psC0vok+oR6R1yHc6/H7G6x3gB3RR/RSgV0P7/1G3v/xZ1B3F/7Nkf0Ctw==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Global Styles */
    body {
      background: #f0f8ff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
    }
    /* Navbar & Icons */
    .navbar-brand i {
      margin-right: 8px;
    }
    /* Card Styles */
    .card {
      margin-bottom: 20px;
      border: none;
      border-radius: 12px;
      overflow: hidden;
      background: #ffffff;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }
    /* Fade-in Animation */
    .fade-in {
      animation: fadeIn 0.8s ease-in-out;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .pointer {
      cursor: pointer;
    }
    /* Table Hover */
    .table-hover tbody tr:hover {
      background-color: #f1f7ff;
    }
    /* Input with Icon */
    .input-group .form-control {
      border-right: none;
    }
    .input-group-text {
      background-color: #e9ecef;
      border-left: none;
      color: #007bff;
    }
    /* Toast Position */
    #toastContainer {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1055;
    }
    /* Invoice Modal Custom */
    .invoice-table th, .invoice-table td {
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <!-- Toast Container for notifications -->
  <div id="toastContainer"></div>
  
  <!-- Navigation Bar with Tabs -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="fa-solid fa-cow" aria-hidden="true"></i> Milk Distributor
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTabs" 
              aria-controls="navbarTabs" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarTabs">
        <ul class="nav nav-tabs ms-auto" id="myTab" role="tablist">
          <!-- All Customers Tab -->
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="allCustomers-tab" data-bs-toggle="tab" data-bs-target="#allCustomers" 
                    type="button" role="tab" aria-controls="allCustomers" aria-selected="true">
              <i class="fa-solid fa-list" aria-hidden="true"></i> All Customers
            </button>
          </li>
          <!-- Registration Tab -->
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="addCustomer-tab" data-bs-toggle="tab" data-bs-target="#addCustomer" 
                    type="button" role="tab" aria-controls="addCustomer" aria-selected="false">
              <i class="fa-solid fa-user-plus" aria-hidden="true"></i> Registration
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- Main Tab Content -->
  <div class="container my-4">
    <div class="tab-content" id="myTabContent">
      <!-- All Customers Tab Pane -->
      <div class="tab-pane fade show active" id="allCustomers" role="tabpanel" aria-labelledby="allCustomers-tab">
        <h1 class="text-center mb-4"><i class="fa-solid fa-users" aria-hidden="true"></i> All Customers</h1>
        <!-- Search Filter -->
        <div class="row mb-3">
          <div class="col-12 col-md-6">
            <div class="input-group">
              <span class="input-group-text" id="searchIcon" aria-label="Search">
                <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
              </span>
              <input type="text" class="form-control search-input" placeholder="Search by name or ID" 
                     id="searchInput" aria-describedby="searchIcon" />
            </div>
          </div>
        </div>
        <!-- All Customers Table -->
        <div class="card fade-in">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="customersTable">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Customer ID</th>
                    <th>Name</th>
                    <th>Phone No</th>
                    <th>Address</th>
                    <th>Quantity (This Month)</th>
                  </tr>
                </thead>
                <tbody id="customersTableBody">
                  <!-- Customers will be rendered here -->
                </tbody>
              </table>
            </div>
            <nav>
              <ul class="pagination justify-content-center">
                <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item"><a class="page-link" href="#">Next</a></li>
              </ul>
            </nav>
          </div>
        </div>
        
        <!-- Customer Details & Daily Data Section -->
        <div id="customerDetailsSection" class="fade-in" style="display: none;">
          <!-- Customer Details -->
          <div class="card">
            <div class="card-header bg-info text-white">
              <i class="fa-solid fa-address-card" aria-hidden="true"></i> Customer Details
            </div>
            <div class="card-body">
              <p><strong>Name:</strong> <span id="detailName"></span></p>
              <p><strong>Customer ID:</strong> <span id="detailID"></span></p>
              <p><strong>Phone No:</strong> <span id="detailPhone"></span></p>
              <p><strong>Address:</strong> <span id="detailAddress"></span></p>
            </div>
          </div>
          
          <!-- Add Data Today Section -->
          <div class="card">
            <div class="card-header bg-success text-white">
              <i class="fa-solid fa-calendar-plus" aria-hidden="true"></i> Add Data Today
            </div>
            <div class="card-body">
              <div class="mb-3">
                <p id="selectedCustomer" class="fw-bold text-primary">No customer selected.</p>
              </div>
              <form id="addDataForm" onsubmit="saveTodayData(event)">
                <div class="mb-3">
                  <label for="todayDate" class="form-label">Date</label>
                  <input type="date" class="form-control" id="todayDate" required />
                </div>
                <!-- Milk Type Dropdown -->
                <div class="mb-3">
                  <label for="milkType" class="form-label">Milk Type</label>
                  <select id="milkType" class="form-select" required>
                    <option value="cow" selected>Cow Milk</option>
                    <option value="buffalo">Buffalo Milk</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="todayQuantity" class="form-label">Quantity (in liters)</label>
                  <input type="number" class="form-control" id="todayQuantity" placeholder="Enter quantity" required />
                </div>
                <div class="mb-3">
                  <label for="todayPrice" class="form-label">Price (in ₹)</label>
                  <input type="number" readonly class="form-control" id="todayPrice" value="70" required />
                </div>
                <button type="submit" class="btn btn-primary w-100">
                  <i class="fa-solid fa-save" aria-hidden="true"></i> Save
                </button>
              </form>
            </div>
          </div>
          
          <!-- Daily Data Entries Section with Filtering -->
          <div class="card">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
              <span><i class="fa-solid fa-table" aria-hidden="true"></i> Customer Data Table</span>
              <!-- Dropdown to filter by available data range -->
              <select id="monthSelector" class="form-select form-select-sm w-auto" onchange="filterMonthData()">
                <option value="all" selected>All</option>
                <option value="current">This Month</option>
                <option value="6months">Last 6 Months</option>
              </select>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered" id="dataTable">
                  <thead class="table-light">
                    <tr>
                      <th>#</th>
                      <th>Date</th>
                      <th>Day</th>
                      <th>Customer ID</th>
                      <th>Customer Name</th>
                      <th>Milk Type</th>
                      <th>Quantity</th>
                      <th>Price (in ₹)</th>
                      <th>Edit</th>
                    </tr>
                  </thead>
                  <tbody id="dataTableBody">
                    <!-- Daily data entries will be rendered here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Summary Section -->
          <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
              <span><i class="fa-solid fa-chart-line" aria-hidden="true"></i> Summary</span>
              <button class="btn btn-sm btn-light" onclick="generateInvoice()">
                <i class="fa-solid fa-file-invoice" aria-hidden="true"></i> Generate Invoice
              </button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered" id="summaryTable">
                  <thead class="table-light">
                    <tr>
                      <th>Customer ID</th>
                      <th>Customer Name</th>
                      <th>Total Days</th>
                      <th>Total Quantity</th>
                      <th>AVG Price (in ₹)</th>
                      <th>Total Payment (in ₹)</th>
                      <th>Due Payment (in ₹)</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="summaryTableBody">
                    <!-- Summary rows will be rendered here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Registration Tab Pane -->
      <div class="tab-pane fade" id="addCustomer" role="tabpanel" aria-labelledby="addCustomer-tab">
        <h1 class="text-center mb-4"><i class="fa-solid fa-user-plus" aria-hidden="true"></i> Registration</h1>
        <div class="card fade-in">
          <div class="card-body">
            <form id="addCustomerForm" onsubmit="registerCustomer(event)">
              <div class="mb-3">
                <label for="customerName" class="form-label">Name</label>
                <input type="text" class="form-control" id="customerName" placeholder="Enter your name" required autocomplete="name" />
              </div>
              <div class="mb-3">
                <label for="customerPhone" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="customerPhone" placeholder="Enter your phone number" required autocomplete="tel" pattern="\d{10}" />
              </div>
              <div class="mb-3">
                <label for="customerAddress" class="form-label">Address</label>
                <input type="text" class="form-control" id="customerAddress" placeholder="Enter your address" required autocomplete="street-address" list="addressSuggestions" />
                <datalist id="addressSuggestions">
                  <option value="123 Milk St">
                  <option value="456 Dairy Ave">
                  <option value="789 Cream Rd">
                </datalist>
              </div>
              <div class="mb-3">
                <label for="customerPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="customerPassword" placeholder="Enter password" required minlength="6" autocomplete="new-password" />
              </div>
              <button type="submit" class="btn btn-primary w-100">
                <i class="fa-solid fa-plus" aria-hidden="true"></i> Register
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Invoice Modal -->
  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-secondary text-white">
          <h5 class="modal-title" id="invoiceModalLabel">
            <i class="fa-solid fa-file-invoice" aria-hidden="true"></i> Invoice Summary
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="invoiceContent">
            <!-- Invoice details will be generated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fa-solid fa-xmark" aria-hidden="true"></i> Close
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Edit Modal for Daily Data -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning text-white">
          <h5><i class="fa-solid fa-pen-to-square" aria-hidden="true"></i> Edit Data</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editDataForm" onsubmit="saveEditData(event)">
            <div class="mb-3">
              <label for="editQuantity" class="form-label">Quantity</label>
              <input type="number" class="form-control" id="editQuantity" required />
            </div>
            <div class="mb-3">
              <label for="editPrice" class="form-label">Price (in ₹)</label>
              <input type="number" class="form-control" id="editPrice" required />
            </div>
            <div class="d-flex justify-content-end">
              <button type="submit" class="btn btn-primary me-2">
                <i class="fa-solid fa-save" aria-hidden="true"></i> Save
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fa-solid fa-xmark" aria-hidden="true"></i> Close
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap Bundle JS (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Custom JavaScript -->
  <script>
    /***********************
     * Global Variables & Data Persistence
     ***********************/
    let dailyData = [];
    let currentEditingRow = null;
    let currentCustomerId = null; // Set when a customer row is clicked.
    let summaryData = {};
    
    // For demo purposes, customers are stored in a global object.
    const customers = {
      1: { name: "John Doe", id: 1, phone: "1234567890", address: "123 Milk St", monthQuantity: 50, paymentStatus: "Pending" },
      2: { name: "Jane Smith", id: 2, phone: "0987654321", address: "456 Dairy Ave", monthQuantity: 30, paymentStatus: "Pending" },
      3: { name: "Bob Johnson", id: 3, phone: "5551234567", address: "789 Cream Rd", monthQuantity: 40, paymentStatus: "Pending" }
    };
    
    // Load or initialize dailyData from localStorage.
    if (!localStorage.getItem("dailyData")) {
      dailyData = [
        { date: "2023-09-01", quantity: "10", price: "700", customerId: 1, milkType: "cow" },
        { date: "2023-09-02", quantity: "5", price: "350", customerId: 2, milkType: "cow" },
        { date: "2023-09-03", quantity: "8", price: "560", customerId: 3, milkType: "cow" },
        { date: "2023-09-04", quantity: "12", price: "840", customerId: 1, milkType: "cow" }
      ];
      localStorage.setItem("dailyData", JSON.stringify(dailyData));
    } else {
      dailyData = JSON.parse(localStorage.getItem("dailyData"));
    }
    
    /***********************
     * Milk Rates
     ***********************/
    const milkRates = {
      cow: 70,
      buffalo: 80
    };
    
    /***********************
     * Rendering Functions
     ***********************/
    function renderCustomersTable() {
      const tbody = document.getElementById("customersTableBody");
      tbody.innerHTML = "";
      let index = 1;
      for (let id in customers) {
        const cust = customers[id];
        const row = document.createElement("tr");
        row.id = "customerRow-" + cust.id;
        row.className = "pointer";
        row.setAttribute("onclick", "showCustomerDetails(" + cust.id + ")");
        row.innerHTML = `<td>${index++}</td>
                         <td>${cust.id}</td>
                         <td>${cust.name}</td>
                         <td>${cust.phone}</td>
                         <td>${cust.address}</td>
                         <td>${cust.monthQuantity}L</td>`;
        tbody.appendChild(row);
      }
    }
    
    function renderDailyDataTable() {
      const tbody = document.getElementById("dataTableBody");
      tbody.innerHTML = "";
      dailyData.forEach((entry, idx) => {
        const row = document.createElement("tr");
        const dayName = getDayName(entry.date);
        row.innerHTML = `<td>${idx + 1}</td>
                         <td>${entry.date}</td>
                         <td>${dayName}</td>
                         <td>${entry.customerId}</td>
                         <td>${customers[entry.customerId].name}</td>
                         <td>${entry.milkType === "buffalo" ? "Buffalo Milk" : "Cow Milk"}</td>
                         <td>${entry.quantity}L</td>
                         <td>₹${entry.price}</td>
                         <td>
                           <button class="btn btn-sm btn-warning" onclick="openEditModalFromIndex(${idx}, event, this)">
                             <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
                           </button>
                         </td>`;
        tbody.appendChild(row);
      });
    }
    
    function renderSummaryTable() {
      const summary = computeSummary();
      const tbody = document.getElementById("summaryTableBody");
      tbody.innerHTML = "";
      for (let custId in summary) {
        const data = summary[custId];
        const cust = customers[custId];
        const avgPrice = data.totalQuantity > 0 ? (data.totalPayment / data.totalQuantity).toFixed(2) : "0";
        const status = cust.paymentStatus || "Pending";
        const row = document.createElement("tr");
        row.innerHTML = `<td>${custId}</td>
                         <td>${cust.name}</td>
                         <td>${data.totalDays}</td>
                         <td>${data.totalQuantity}L</td>
                         <td>₹${avgPrice}</td>
                         <td>₹${data.totalPayment}</td>
                         <td>₹${data.totalPayment}</td>
                         <td>${status}</td>`;
        tbody.appendChild(row);
      }
    }
    
    function updateCustomersMonthlyQuantity() {
      for (let id in customers) {
        customers[id].monthQuantity = 0;
      }
      dailyData.forEach(entry => {
        customers[entry.customerId].monthQuantity += parseFloat(entry.quantity);
      });
      renderCustomersTable();
    }
    
    function computeSummary() {
      let summary = {};
      dailyData.forEach(entry => {
        if (!summary[entry.customerId]) {
          summary[entry.customerId] = { totalDays: 0, totalQuantity: 0, totalPayment: 0 };
        }
        summary[entry.customerId].totalDays++;
        summary[entry.customerId].totalQuantity += parseFloat(entry.quantity);
        summary[entry.customerId].totalPayment += parseFloat(entry.price);
      });
      return summary;
    }
    
    /***********************
     * Event Handlers & Initialization
     ***********************/
    function initialize() {
      renderCustomersTable();
      renderDailyDataTable();
      renderSummaryTable();
    }
    document.addEventListener("DOMContentLoaded", initialize);
    
    function getDayName(dateStr) {
      const dateObj = new Date(dateStr);
      const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      return days[dateObj.getDay()];
    }
    
    function showCustomerDetails(customerId) {
      currentCustomerId = customerId;
      const cust = customers[customerId];
      if (cust) {
        document.getElementById("detailName").innerText = cust.name;
        document.getElementById("detailID").innerText = cust.id;
        document.getElementById("detailPhone").innerText = cust.phone;
        document.getElementById("detailAddress").innerText = cust.address;
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("todayDate").value = today;
        document.getElementById("selectedCustomer").innerText = "Selected Customer: " + cust.name + " (ID: " + cust.id + ")";
        document.getElementById("customerDetailsSection").style.display = "block";
        window.scrollTo({ top: document.getElementById("customerDetailsSection").offsetTop, behavior: "smooth" });
      }
    }
    
    // Update price automatically based on quantity and selected milk type.
    function updatePrice() {
      const qty = parseFloat(document.getElementById("todayQuantity").value) || 0;
      const milkType = document.getElementById("milkType").value;
      const rate = milkRates[milkType];
      // If no quantity, display default rate.
      document.getElementById("todayPrice").value = qty > 0 ? qty * rate : rate;
    }
    document.getElementById("todayQuantity").addEventListener("input", updatePrice);
    document.getElementById("milkType").addEventListener("change", updatePrice);
    
    function saveTodayData(event) {
      event.preventDefault();
      if (!currentCustomerId) {
        showToast("Please select a customer first.", "danger");
        return;
      }
      const date = document.getElementById("todayDate").value;
      const quantity = document.getElementById("todayQuantity").value;
      const price = document.getElementById("todayPrice").value;
      const milkType = document.getElementById("milkType").value;
      const dayName = getDayName(date);
      const newEntry = {
        date: date,
        quantity: quantity,
        price: price,
        customerId: currentCustomerId,
        milkType: milkType
      };
      dailyData.push(newEntry);
      updateCustomersMonthlyQuantity();
      renderDailyDataTable();
      renderSummaryTable();
      showToast("Data saved successfully!", "success");
      document.getElementById("addDataForm").reset();
      // Reset price to default for cow milk.
      document.getElementById("todayPrice").value = milkRates["cow"];
    }
    
    // Registration: Customer Registration function (email removed)
    function registerCustomer(event) {
      event.preventDefault();
      const name = document.getElementById("customerName").value;
      const phone = document.getElementById("customerPhone").value;
      const address = document.getElementById("customerAddress").value;
      const password = document.getElementById("customerPassword").value;
      
      console.log("Registering new customer:", name);
      
      const newId = Object.keys(customers).length + 1;
      customers[newId] = { 
        name, 
        id: newId, 
        phone, 
        address, 
        password,  // In production, use hashed passwords!
        monthQuantity: 0,
        paymentStatus: "Pending"
      };
      // Persist updated customers to localStorage.
      localStorage.setItem("customers", JSON.stringify(customers));
      renderCustomersTable();
      showToast("Customer registered successfully!", "success");
      document.getElementById("addCustomerForm").reset();
    }
    
    // Toast notifications
    function showToast(message, type) {
      console.log("Showing toast:", message);
      const toastContainer = document.getElementById("toastContainer");
      const toastEl = document.createElement("div");
      toastEl.className = `toast align-items-center text-bg-${type} border-0`;
      toastEl.setAttribute("role", "alert");
      toastEl.setAttribute("aria-live", "assertive");
      toastEl.setAttribute("aria-atomic", "true");
      toastEl.innerHTML = `<div class="d-flex">
                              <div class="toast-body">${message}</div>
                              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                           </div>`;
      toastContainer.appendChild(toastEl);
      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();
      toastEl.addEventListener("hidden.bs.toast", () => { toastEl.remove(); });
    }
    
    /***********************
     * Edit Daily Data Functions
     ***********************/
    function openEditModalFromIndex(index, event, btn) {
      event.stopPropagation();
      currentEditingRow = btn.closest("tr");
      const entry = dailyData[index];
      document.getElementById("editQuantity").value = entry.quantity;
      document.getElementById("editPrice").value = entry.price;
      currentEditingRow.dataset.editIndex = index;
      const myModal = new bootstrap.Modal(document.getElementById("editModal"));
      myModal.show();
    }
    
    function saveEditData(event) {
      event.preventDefault();
      const newQuantity = document.getElementById("editQuantity").value;
      const newPrice = document.getElementById("editPrice").value;
      const editIndex = currentEditingRow.dataset.editIndex;
      if (editIndex !== undefined) {
        dailyData[editIndex].quantity = newQuantity;
        dailyData[editIndex].price = newPrice;
      }
      renderDailyDataTable();
      recalcSummaryAndUpdate();
      showToast("Data updated successfully!", "success");
      const modalEl = document.getElementById("editModal");
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    function recalcSummaryAndUpdate() {
      updateCustomersMonthlyQuantity();
      renderSummaryTable();
    }
    
    /***********************
     * Invoice & Payment Integration (Simulated)
     ***********************/
    function generateInvoice() {
      let content = `<h5 class="mb-3">Invoice Summary</h5>
                     <div class="table-responsive">
                     <table class="table table-bordered invoice-table">
                       <thead class="table-light">
                         <tr>
                           <th>Customer ID</th>
                           <th>Customer Name</th>
                           <th>Total Payment (in ₹)</th>
                           <th>Status</th>
                           <th>Actions</th>
                         </tr>
                       </thead>
                       <tbody>`;
      let hasPending = false;
      const summary = computeSummary();
      for (const custId in summary) {
        const data = summary[custId];
        const cust = customers[custId];
        if (data.totalPayment > 0 && cust.paymentStatus === "Pending") {
          hasPending = true;
          content += `<tr>
                        <td>${custId}</td>
                        <td>${cust.name}</td>
                        <td>₹${data.totalPayment}</td>
                        <td>${cust.paymentStatus}</td>
                        <td>
                          <button class="btn btn-sm btn-success me-2" onclick="payInvoice(${custId})">
                            <i class="fa-solid fa-credit-card" aria-hidden="true"></i> Pay Now
                          </button>
                          <button class="btn btn-sm btn-warning" onclick="sendReminder(${custId})">
                            <i class="fa-solid fa-bell" aria-hidden="true"></i> Send Reminder
                          </button>
                        </td>
                      </tr>`;
        }
      }
      content += `</tbody></table></div>`;
      if (!hasPending) {
        content = `<p class="text-center">All invoices are paid!</p>`;
      }
      document.getElementById("invoiceContent").innerHTML = content;
      const invoiceModal = new bootstrap.Modal(document.getElementById("invoiceModal"));
      invoiceModal.show();
    }
    
    function payInvoice(custId) {
      showToast("Redirecting to payment gateway for Customer ID " + custId + " ...", "info");
      setTimeout(() => {
        customers[custId].paymentStatus = "Success";
        renderSummaryTable();
        showToast("Payment successful for Customer ID " + custId + "!", "success");
      }, 1500);
    }
    
    function sendReminder(custId) {
      const cust = customers[custId];
      showToast("Payment reminder sent to " + cust.name + "!", "warning");
    }
    
    /***********************
     * Search Filter
     ***********************/
    document.getElementById("searchInput").addEventListener("keyup", function() {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll("#customersTable tbody tr");
      rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
      });
    });
    
    /***********************
     * Filter Daily Data by Date Range
     ***********************/
    function filterMonthData() {
      const value = document.getElementById("monthSelector").value;
      const today = new Date();
      let filtered = dailyData.map((entry, index) => ({ ...entry, originalIndex: index }));
      
      if (value === "current") {
        filtered = filtered.filter(entry => {
          const d = new Date(entry.date);
          return d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear();
        });
      } else if (value === "6months") {
        let sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
        filtered = filtered.filter(entry => {
          const d = new Date(entry.date);
          return d >= sixMonthsAgo && d <= today;
        });
      }
      
      // Render filtered data into the daily data table.
      const tbody = document.getElementById("dataTableBody");
      tbody.innerHTML = "";
      filtered.forEach((entry, idx) => {
        const row = document.createElement("tr");
        const dayName = getDayName(entry.date);
        row.innerHTML = `<td>${idx + 1}</td>
                         <td>${entry.date}</td>
                         <td>${dayName}</td>
                         <td>${entry.customerId}</td>
                         <td>${customers[entry.customerId].name}</td>
                         <td>${entry.milkType === "buffalo" ? "Buffalo Milk" : "Cow Milk"}</td>
                         <td>${entry.quantity}L</td>
                         <td>₹${entry.price}</td>
                         <td>
                           <button class="btn btn-sm btn-warning" onclick="openEditModalFromFiltered(${entry.originalIndex}, event, this)">
                             <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
                           </button>
                         </td>`;
        tbody.appendChild(row);
      });
    }
    
    // Use this function when editing from the filtered list so that the original index is used.
    function openEditModalFromFiltered(originalIndex, event, btn) {
      event.stopPropagation();
      currentEditingRow = btn.closest("tr");
      const entry = dailyData[originalIndex];
      document.getElementById("editQuantity").value = entry.quantity;
      document.getElementById("editPrice").value = entry.price;
      currentEditingRow.dataset.editIndex = originalIndex;
      const myModal = new bootstrap.Modal(document.getElementById("editModal"));
      myModal.show();
    }
    
    /***********************
     * Edit Daily Data Functions
     ***********************/
    function openEditModalFromIndex(index, event, btn) {
      event.stopPropagation();
      currentEditingRow = btn.closest("tr");
      const entry = dailyData[index];
      document.getElementById("editQuantity").value = entry.quantity;
      document.getElementById("editPrice").value = entry.price;
      currentEditingRow.dataset.editIndex = index;
      const myModal = new bootstrap.Modal(document.getElementById("editModal"));
      myModal.show();
    }
    
    function saveEditData(event) {
      event.preventDefault();
      const newQuantity = document.getElementById("editQuantity").value;
      const newPrice = document.getElementById("editPrice").value;
      const editIndex = currentEditingRow.dataset.editIndex;
      if (editIndex !== undefined) {
        dailyData[editIndex].quantity = newQuantity;
        dailyData[editIndex].price = newPrice;
      }
      renderDailyDataTable();
      recalcSummaryAndUpdate();
      showToast("Data updated successfully!", "success");
      const modalEl = document.getElementById("editModal");
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    function recalcSummaryAndUpdate() {
      updateCustomersMonthlyQuantity();
      renderSummaryTable();
    }
    
    /***********************
     * Invoice & Payment Integration (Simulated)
     ***********************/
    function generateInvoice() {
      let content = `<h5 class="mb-3">Invoice Summary</h5>
                     <div class="table-responsive">
                     <table class="table table-bordered invoice-table">
                       <thead class="table-light">
                         <tr>
                           <th>Customer ID</th>
                           <th>Customer Name</th>
                           <th>Total Payment (in ₹)</th>
                           <th>Status</th>
                           <th>Actions</th>
                         </tr>
                       </thead>
                       <tbody>`;
      let hasPending = false;
      const summary = computeSummary();
      for (const custId in summary) {
        const data = summary[custId];
        const cust = customers[custId];
        if (data.totalPayment > 0 && cust.paymentStatus === "Pending") {
          hasPending = true;
          content += `<tr>
                        <td>${custId}</td>
                        <td>${cust.name}</td>
                        <td>₹${data.totalPayment}</td>
                        <td>${cust.paymentStatus}</td>
                        <td>
                          <button class="btn btn-sm btn-success me-2" onclick="payInvoice(${custId})">
                            <i class="fa-solid fa-credit-card" aria-hidden="true"></i> Pay Now
                          </button>
                          <button class="btn btn-sm btn-warning" onclick="sendReminder(${custId})">
                            <i class="fa-solid fa-bell" aria-hidden="true"></i> Send Reminder
                          </button>
                        </td>
                      </tr>`;
        }
      }
      content += `</tbody></table></div>`;
      if (!hasPending) {
        content = `<p class="text-center">All invoices are paid!</p>`;
      }
      document.getElementById("invoiceContent").innerHTML = content;
      const invoiceModal = new bootstrap.Modal(document.getElementById("invoiceModal"));
      invoiceModal.show();
    }
    
    function payInvoice(custId) {
      showToast("Redirecting to payment gateway for Customer ID " + custId + " ...", "info");
      setTimeout(() => {
        customers[custId].paymentStatus = "Success";
        renderSummaryTable();
        showToast("Payment successful for Customer ID " + custId + "!", "success");
      }, 1500);
    }
    
    function sendReminder(custId) {
      const cust = customers[custId];
      showToast("Payment reminder sent to " + cust.name + "!", "warning");
    }
    
    /***********************
     * Search Filter
     ***********************/
    document.getElementById("searchInput").addEventListener("keyup", function() {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll("#customersTable tbody tr");
      rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
      });
    });
  </script>
</body>
</html>
